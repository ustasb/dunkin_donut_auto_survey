<!DOCTYPE html>
<html lang="en">
<head>
  <title>Dunkin' Donuts Auto-Survey</title>
  <meta charset="utf-8">
  <link type="text/css" rel="stylesheet" href="vendor/pure-0.4.2.min.css">
  <link href='http://fonts.googleapis.com/css?family=Maven+Pro' rel='stylesheet' type='text/css'>
  <script src="vendor/jquery-1.11.0.min.js"></script>
  <style>
    body {
      text-align: center;
      font-family: 'Maven Pro', sans-serif;
    }

    input {
      margin: 20px 5px;
    }

    a {
      color: #FC772A; /* Dunkin' Donuts orange */
    }

    b {
      color: #D81860; /* Dunkin' Donuts pink */
    }

    .pure-button-primary {
      background-color: #D81860;
    }

    #content-wrapper {
      width: 450px;
      margin: auto;
    }

    #survey-code-1, #survey-code-2 {
      width: 70px;
    }

    #survey-code-3, #survey-code-4 {
      width: 60px;
    }

    #submit-status {
      display: none;
      margin-top: 15px;
    }

    #submit-status {
      font-style: italic;
    }
  </style>
</head>
<body>

  <div id="content-wrapper">
    <h1>Dunkin' Donuts Auto-Survey</h1>

    <span>
      Automatically completes a Dunkin' Donuts
      <a href="https://www.telldunkin.com/">survey</a>
      to earn you
      <b>a free donut!</b>
    </span>

    <br><br>

    <form id="foo" class="pure-form" action="javascript:void(0);">
      <fieldset>
        <label for="survey-code-1">
          <a href="images/receipt-half.png">Survey Code</a>
        </label>

        <br>

        <input id="survey-code-1" maxlength="5" tabIndex="1"> -
        <input id="survey-code-2" maxlength="5" tabIndex="2"> -
        <input id="survey-code-3" maxlength="4" tabIndex="3"> -
        <input id="survey-code-4" maxlength="4" tabIndex="4">

        <br>

        <button type="submit" class="pure-button pure-button-primary" tabIndex="5">Get Validation Code</button>
      </fieldset>
    </form>

    <div id="submit-status">Percent Complete: 0%</div>
  </div>

  <script>
    var $window = $(window),
        $contentWrapper = $('#content-wrapper'),
        $button = $('button'),
        $inputs = $('input'),
        $status = $('#submit-status'),
        eventSource = null;

    function validateSurveyCode(surveyCode) {
      return /^\w{5}-\w{5}-\w{4}-\w{4}$/.test(surveyCode);
    }

    function getSurveyCode() {
      return $inputs.map(function () {
        return $(this).val();
      }).toArray().join('-');
    }

    function disableInput() {
      $button.prop('disabled', true);
      $inputs.prop('disabled', true);
    }

    function enableInput() {
      $button.prop('disabled', false);
      $inputs.prop('disabled', false);
    }

    function showStatus(status) {
      $status.show().text(status);
    }

    function hideStatus(timeout) {
      var timeout = timeout || 0;

      setTimeout(function () {
        $status.hide();
      }, timeout);
    }

    function onSubmit() {
      var surveyCode = getSurveyCode();

      if (true || validateSurveyCode(surveyCode)) {
        disableInput();

        getValidationCode('57601-39117-0903-1449', function () {
          enableInput();
        });
      } else {
        showStatus('Invalid Survey Code!');
        hideStatus(3500);
      }
    }

    function inputKeyUp() {
      var $input = $(this);

      if ($input.val().length >= $input.attr('maxlength')) {
        var nextTabIndex = parseInt($input.attr('tabIndex'), 10) + 1;
        $('*[tabIndex="' + nextTabIndex + '"]').focus();
      }
    }

    function centerContent() {
      var marginTop = ($window.height() - $contentWrapper.height()) / 2;
      var offset = 40;

      marginTop -= offset;
      if (marginTop < 0) { marginTop = 0; }

      $contentWrapper.css('margin-top', marginTop);
    }

    function getValidationCode(surveyCode, onDone) {
      eventSource && eventSource.close();
      eventSource = new EventSource('/validationcode/' + surveyCode);

      eventSource.onmessage = function (e) {
        var status = e.data;
        showStatus(status);

        if (/Done!/.test(status)) {
          eventSource.close();
          eventSource = null;
          onDone();
        }
      };

      eventSource.onerror = function (e) {
        showStatus("An error occured! Try again some other time...");
        eventSource.close();
        eventSource = null;
        onDone();
      };
    }

    function init() {
      centerContent();
      $button.click(onSubmit);
      $inputs.keyup(inputKeyUp);
      $window.resize(centerContent);
    }

    init();
  </script>

</body>
</html>
